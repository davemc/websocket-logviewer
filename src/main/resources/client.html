<html>
<title>WebSocket: Log Service</title>
    <script>
		Timeline_ajax_url="timeline/timeline_ajax/simile-ajax-api.js";
		Timeline_urlPrefix='timeline/timeline_js/';       
		Timeline_parameters='bundle=true';
	</script>
	<script src="timeline/timeline_js/timeline-api.js" type="text/javascript"></script>
	<script type="text/javascript" charset="utf-8" src="jquery.js"></script>
	<script type="text/javascript"> 
        var ws; 
        var filePos = 0;
        var files = {};
        var eventSource = null;
        //var t1 = null;

        var resizeTimerID = null;
        function onResize() {
          if (resizeTimerID == null) {
            resizeTimerID = window.setTimeout(function() {
              resizeTimerID = null;
              tl.layout();
            }, 500);
          }
        }
         
        $(document).ready(function () {
        	eventSource = new Timeline.DefaultEventSource();
            var bandInfos = [
                             Timeline.createBandInfo({
                                 eventSource:    eventSource,
                                 date:           "TIMELINE_DATE",
                                 timeZone:       2,
                                 width:          "50%",
                                 intervalUnit:   Timeline.DateTime.SECOND,
                                 intervalPixels: 100
                             }),
                             Timeline.createBandInfo({
                                 eventSource:    eventSource,
                                 date:           "TIMELINE_DATE",
                                 timeZone:       2,
                                 width:          "20%",
                                 intervalUnit:   Timeline.DateTime.MINUTE,
                                 intervalPixels: 200
                             }),
                             Timeline.createBandInfo({
                                 eventSource:    eventSource,
                                 date:           "TIMELINE_DATE",
                                 timeZone:       2,
                                 width:          "20%",
                                 intervalUnit:   Timeline.DateTime.HOUR,
                                 intervalPixels: 200
                             }),
                             Timeline.createBandInfo({
                                 eventSource:    eventSource,
                                 date:           "TIMELINE_DATE",
                                 timeZone:       2,
                                 width:          "10%",
                                 intervalUnit:   Timeline.DateTime.DAY,
                                 intervalPixels: 200
                             })
                           ];
                           bandInfos[1].syncWith = 0;
                           bandInfos[1].highlight = true;
                           bandInfos[2].syncWith = 0;
                           bandInfos[2].highlight = true;
            tl = Timeline.create(document.getElementById("my-timeline"), bandInfos);
        	
            try {
	            ws = new WebSocket('ws://HOSTNAME:PORT/websocket'); 
            } catch (e) {
            	$('#status').text('The WebSocket Connection could not be opened: ' + e);
            	ws = null;
            }
            if (null != ws) {
                ws.onopen = function(event) { $('#status').text('The WebSocket Connection Is Open.'); } 
    			ws.onmessage = function(event) { 
    				var res = event.data;
    				if (res.lastIndexOf("WS: ") == 0) {
    					$('#status').text(res);
    				} else {
    					var doc = null;
    					try {
        					doc = JSON.parse(res);
    					} catch (e) {
        					doc = null;
    						$('#status').text(e);
    					}
    					if (null != doc) {
        					if (null == doc.error) {
        						$.each(doc.msgs, function() {
        							var entry = this.msg;
        							var entryParts = entry.split(' ');
        							var method = entryParts[5];
        							var result = entryParts[8];
        							var id = entryParts[0];
        							//var logDivName = 'log' + files[this.file];
        							//$('#' + logDivName).prepend(entry);
        							var dateStr = entry.substring(entry.indexOf('[') + 1, entry.indexOf(']'));
        							var dateStr1 = dateStr.substring(0,dateStr.indexOf(':')) + ' ' + dateStr.substring(dateStr.indexOf(':') + 1, dateStr.indexOf(' '));
        							//alert(dateStr1);
        							//21/Jul/2010:17:46:49 +0200
        					        var dateEvent = new Date(dateStr1);
        							//alert(dateEvent);
        					        var vals = {};
        					        vals.start = dateEvent;
        					        vals.text = method + ' ' + result;
        					        vals.description = this.msg;
        							var evt = new Timeline.DefaultEventSource.Event(vals);
        					        eventSource.add(evt);
        						});
        						onResize();
        					} else {
        						$('#status').text(doc.error);
        					}
    					}
    				}
    			}
    			ws.onclose = function(event) { $('#status').text('The WebSocket Connection Has Been Closed.'); } 
            }
        }); 
         
        function clearLog(position){ 
			//if (files[filename] != null) {
	        $('#log' + position).empty();
        }

        function removeLog(position){ 
            var filename = $('#filename' + position).val();
			if (files[filename] != null) {
	            ws.send(filename);
				var pos = files[filename];
				$('#fileDiv' + pos).remove();
	            files[filename] = null;
			}
        }

        function sendFilename(){ 
			var filename = $('#filename').val();
			if (files[filename] == null) {
	            filePos++;
	            files[filename] = filePos;
	            var entry = '<div id="fileDiv' + filePos + '" style="border-style:solid;"><input id="filename'+filePos+'" type="hidden" value="' + filename + '" /><b>' + filename + '</b>  <a href="javascript://" onclick="clearLog(' + filePos + ')">Clear</a>  <a href="javascript://" onclick="removeLog(' + filePos + ')">Remove</a><div id="log' + filePos + '"></div></div>';
	            $('#logfiles').append(entry);
	            ws.send(filename);
			}
        }
    </script>
</head>
<body onresize="onResize();">
<h1>WebSocket: Log Service</h1>
<div id="status"></div>
<br />
Select The Filename to watch
FILES
<input type="button" value="Watch It..." onclick="sendFilename();" />
<br />
<div id="result"></div>
    <div id="my-timeline"
      style="height: 500px; border: 1px solid #aaa">
    </div>
<br />
</body>
</html>